<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>UPI QR Scanner</title>
<style>
body { font-family: sans-serif; margin: 20px; }
#warning {
  background: #ffcccc;
  color: #660000;
  padding: 10px;
  border: 1px solid #cc0000;
  margin-bottom: 15px;
  display: none;
}
#result { margin-top: 15px; }

button, input[type="file"]::file-selector-button {
  padding: 14px 20px;
  font-size: 18px;
  border: none;
  border-radius: 6px;
  background-color: #007bff;
  color: white;
  cursor: pointer;
}

button:hover, input[type="file"]::file-selector-button:hover {
  background-color: #0056b3;
}

input[type="file"] {
  font-size: 16px;
  padding: 10px;
  margin: 5px 0;
}

video {
  width: 100%;
  max-width: 400px;
  display: none;
  margin-top: 10px;
}

button {
  margin: 8px 0;
}
</style>
</head>
<body>

<h1>UPI QR Scanner</h1>
<div id="warning"></div>

<input type="file" id="fileInput" accept="image/*">
<br>
<button id="startCamera">ðŸ“· Start Camera</button>
<button id="stopCamera" style="display:none;">âœ‹ Stop Camera</button>

<video id="preview" autoplay playsinline></video>

<div id="result"></div>
<button id="resetBtn" style="display:none;">ðŸ”„ Reset</button>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
<script>
const warningEl = document.getElementById('warning');
const video = document.getElementById('preview');
const fileInput = document.getElementById('fileInput');
const startCameraBtn = document.getElementById('startCamera');
const stopCameraBtn = document.getElementById('stopCamera');
const resultEl = document.getElementById('result');
const resetBtn = document.getElementById('resetBtn');

let stream = null;
let scanning = false;

function detectInAppBrowser() {
  const ua = navigator.userAgent || navigator.vendor || window.opera;
  const inAppPatterns = [
    'FBAN','FBAV','Instagram','Twitter','Line',
    'WhatsApp','wv', 'Snapchat', 'Messenger'
  ];
  return inAppPatterns.some(p => ua.includes(p));
}

function showWarning(message) {
  warningEl.style.display = 'block';
  warningEl.innerHTML = message;
}

function extractUpiId(text) {
  let match = text.match(/pa=([\w.\-]+@[\w]+)/i);
  if (match) return match[1];
  match = text.match(/[\w.\-]+@[\w]+/);
  return match ? match[0] : null;
}

function displayResult(payload) {
  const upiId = extractUpiId(payload) || 'Not found';
  resultEl.innerHTML = `
    <p><strong>Raw Payload:</strong> ${payload} <button onclick="navigator.clipboard.writeText('${payload}')">Copy</button></p>
    <p><strong>UPI ID:</strong> ${upiId} <button onclick="navigator.clipboard.writeText('${upiId}')">Copy</button></p>
  `;
  resetBtn.style.display = 'inline-block';
}

function resetResult() {
  resultEl.innerHTML = '';
  resetBtn.style.display = 'none';
  fileInput.value = ''; // Allow re-uploading same file
  stopCamera(); // Stop camera if running
}

fileInput.addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    const img = new Image();
    img.onload = () => {
      const canvas = document.createElement('canvas');
      canvas.width = img.width;
      canvas.height = img.height;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0);
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const code = jsQR(imageData.data, canvas.width, canvas.height);
      if (code) {
        displayResult(code.data);
      } else {
        resultEl.innerHTML = '<p>No QR code detected.</p>';
      }
    };
    img.src = ev.target.result;
  };
  reader.readAsDataURL(file);
});

startCameraBtn.addEventListener('click', async () => {
  try {
    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
    video.srcObject = stream;
    video.style.display = 'block';
    stopCameraBtn.style.display = 'inline-block';
    scanning = true;

    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');

    function scan() {
      if (!scanning) return;
      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0);
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imageData.data, canvas.width, canvas.height);
        if (code) {
          displayResult(code.data);
          stopCamera();
          return;
        }
      }
      requestAnimationFrame(scan);
    }
    requestAnimationFrame(scan);
  } catch (err) {
    alert('Camera access denied or not available.');
  }
});

function stopCamera() {
  scanning = false;
  if (stream) {
    stream.getTracks().forEach(track => track.stop());
    stream = null;
  }
  video.style.display = 'none';
  stopCameraBtn.style.display = 'none';
}

stopCameraBtn.addEventListener('click', stopCamera);
resetBtn.addEventListener('click', resetResult);

// Show warnings if in-app or not secure
if (detectInAppBrowser()) {
  showWarning('âš  You are using an in-app browser (e.g. WhatsApp, Instagram). Camera access may not work. Please open this page in your deviceâ€™s main browser like Chrome or Safari.');
} else if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
  showWarning('âš  This page is not served over HTTPS. Camera access will be blocked in most browsers. Host this file on HTTPS or use the upload option.');
}
</script>
</body>
</html>
